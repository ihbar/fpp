#!/bin/bash
#
# startup
#
# Called from rc.local to start FPP
#
#

BINDIR=$(dirname $0)
. ${BINDIR}/common
. ${BINDIR}/functions

# See if we should be running from /home/pi/fpp
if [ "x${BINDIR}" == "x/opt/fpp/scripts" -a -f "/home/pi/fpp/scripts/startup" ]
then
	exec /home/pi/fpp/scripts/startup
fi

# Copy our php.ini script into place for when we restart apache
cp ${FPPDIR}/etc/php.ini /etc/php5/apache2/php.ini

# If the flash drive is not mounted yet, then fix Apache so it can at least start up
if [ ! -d "/home/pi/media/logs" ]
then
	perl -pi -e "s/ErrorLog.*/ErrorLog \/var\/tmp\/apache-error.log/" /etc/apache2/sites-available/default
	/etc/rc2.d/S02apache2 restart
fi

# Configure Network and DNS
${BINDIR}/config_network
${BINDIR}/config_dns

WaitForDHCPIPs

# Workaround for bug raspberry/linux #570 wrong volume when starting playback.
# Playback of silence is done while updating the volume. Pause inserted between operation.
aplay ${BINDIR}/silence_5sec.wav &

amixer cset numid=3 1

ORIGVOLUME=$(getSetting volume)
VOLUME=$(expr ${ORIGVOLUME} / 2 + 50)
amixer set PCM ${VOLUME}%
sleep 6;


# Let's check that our .asoundrc is as valid as we care about right now
if [ ! -e /proc/asound/card$(sed -n '/card [0-9]*/p' /root/.asoundrc | head -n 1 | awk '{print $2}') ]; then
	echo "Configured sound card might not exist, let's set it to 0 as a default."
	sed -i 's/card [0-9]/card 0/' /root/.asoundrc
fi

# Print/Say the IP address
_IP=$(hostname -I) || true
if [ "$_IP" ]; then
  printf "My IP address is %s\n" "$_IP"
  arrHost=(${_IP// / })
  flite -voice kal "I Have Found The Following I P Addresses, ${arrHost[0]}, ${arrHost[1]},  ${arrHost[2]}"
fi

# Check for flash drive mounted
while [ true ]
do
if [ "$(df -h ${MEDIADIR} | tail -n 1 | awk '{print $1}')" == "$(df -h / | tail -n 1 | awk '{print $1}')" ];
then
	echo "Flash Media Is Missing.  Please Insert.";
	flite -voice kal "Boot Stalled, Flash Media Is Missing.  Please Insert."
	sleep 5;
	mount -a;
else
	echo "Flash Media mounted, checking for required subdirectories.";
	DIRS="config effects events logs music playlists scripts sequences upload videos"
	for DIR in ${DIRS}
	do
		if [ ! -d /home/pi/media/${DIR} ]
		then
			mkdir -p /home/pi/media/${DIR}
			chown pi.pi /home/pi/media/${DIR}
		fi
	done

	break
fi
done

sysctl net/ipv4/igmp_max_memberships=150
/usr/local/bin/gpio load spi 100

# mpg123 ${FPPDIR}/bin/silence.mp3 > /dev/null

sed -e "s#FPPDIR#${FPPDIR}#g" < ${FPPDIR}/etc/apache2.site > /etc/apache2/sites-available/default
/etc/rc2.d/S02apache2 restart

${BINDIR}/piRTC

${BINDIR}/fpp_boot

PiLCDenabled=$(awk -f ${FPPDIR}/scripts/readSetting.awk /home/pi/media/settings setting=PI_LCD_Enabled)
echo $PiLCDenabled

if [[ $PiLCDenabled == "true" ]]
then
  echo "LCD Enabled"
  ${FPPDIR}/scripts/lcd/fppLCD start
else
  echo "LCD Disabled"
fi

##############################################################################
# Leave these things till last so user can see output of anything above here
##############################################################################
SCREENSAVER=$(getSetting screensaver)
if [ "x${SCREENSAVER}" = "x1" ]
then
	setterm -blank 1
else
	setterm -blank 0
fi

# Sleep for just a little while so the use can see the login prompt before
# we display the logo
(sleep 60 ; /usr/bin/fbi -T 1 -noverbose -a /etc/splash.png) &

